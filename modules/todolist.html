<!-- Todolist Module -->
<div id="module-todolist" class="hidden">
  <nav class="navbar">
    <div class="brand">
      <i class="fas fa-check-circle"></i> 云端清单
    </div>
    <div class="user-info">
      <span class="sync-indicator" id="sync-indicator"></span>
      <span id="user-display-todo">加载中...</span>
    </div>
  </nav>

  <div class="container" style="margin-top: 2rem; margin-bottom: 6rem;">
    <header class="mb-8 flex justify-between items-end" style="display: flex; justify-content: space-between; align-items: flex-end;">
      <div>
        <h1 class="text-3xl font-bold" style="font-size: 1.875rem; font-weight: 700;">我的任务</h1>
        <p id="date-string" class="text-slate-400" style="color: #94a3b8;"></p>
      </div>
      <div style="background: white; padding: 0.75rem 1.25rem; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; text-align: center; min-width: 80px;">
        <div style="font-size: 0.75rem; color: #94a3b8; font-weight: 700; text-transform: uppercase;">今日完成</div>
        <div id="stat-today" class="text-xl font-bold" style="font-size: 1.25rem; font-weight: 700; color: #3b82f6;">0</div>
      </div>
    </header>

    <div class="glass-card rounded-2xl p-4 mb-8" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 1rem; padding: 1rem; margin-bottom: 2rem;">
      <div style="display: flex; gap: 0.5rem;">
        <input type="text" id="task-input" placeholder="添加新任务..." style="flex: 1; padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 0.75rem; font-family: inherit; font-size: 1rem;">
        <button id="add-task-btn" class="btn btn-primary" style="padding: 0.75rem 1.5rem; border: none; border-radius: 0.75rem; font-weight: 600; cursor: pointer; background-color: #3b82f6; color: white;">添加</button>
      </div>
    </div>

    <div id="task-list" class="space-y-3" style="display: flex; flex-direction: column; gap: 0.75rem;">
      <!-- 任务项将动态渲染在这里 -->
    </div>
  </div>
</div>

<script>
// Todolist 模块脚本将在主js中初始化
window.todolistModule = {
  tasks: [],
  init(dbManager) {
    this.dbManager = dbManager;
    document.getElementById('add-task-btn').addEventListener('click', () => this.addTask());
    document.getElementById('task-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') this.addTask();
    });
    this.setupDateDisplay();
    this.listenToTasks();
  },

  setupDateDisplay() {
    document.getElementById('date-string').innerText = new Date().toLocaleDateString('zh-CN', { 
      weekday: 'long', 
      month: 'long', 
      day: 'numeric' 
    });
  },

  listenToTasks() {
    if (!this.dbManager) return;
    this.dbManager.onTasksSnapshot((tasks) => {
      this.tasks = tasks;
      this.render();
    });
  },

  async addTask() {
    const input = document.getElementById('task-input');
    if (!input.value.trim()) return;
    
    try {
      await this.dbManager.addTask(input.value);
      input.value = "";
    } catch (error) {
      alert("添加任务失败: " + error.message);
    }
  },

  async toggleTask(id, currentStatus) {
    try {
      await this.dbManager.updateTask(id, { completed: !currentStatus });
    } catch (error) {
      alert("更新任务失败: " + error.message);
    }
  },

  async deleteTask(id) {
    try {
      await this.dbManager.deleteTask(id);
    } catch (error) {
      alert("删除任务失败: " + error.message);
    }
  },

  render() {
    const list = document.getElementById('task-list');
    list.innerHTML = this.tasks.map(t => `
      <div class="glass-card p-4 rounded-xl flex items-center justify-between" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); padding: 1rem; border-radius: 0.75rem; display: flex; align-items: center; justify-content: space-between;">
        <div class="flex items-center gap-3 cursor-pointer" onclick="window.todolistModule.toggleTask('${t.id}', ${t.completed})" style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; flex: 1;">
          <div class="checkbox-custom ${t.completed ? 'checked' : ''}" style="width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 6px; display: flex; align-items: center; justify-content: center; ${t.completed ? 'background-color: #10b981; border-color: #10b981;' : ''}">
            ${t.completed ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
          </div>
          <span style="${t.completed ? 'text-decoration: line-through; color: #94a3b8;' : 'color: #1e293b; font-weight: 500;'}">${t.text}</span>
        </div>
        <button onclick="window.todolistModule.deleteTask('${t.id}')" style="background: none; border: none; color: #cbd5e1; cursor: pointer; font-size: 1rem; transition: all 0.2s ease;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#cbd5e1'">
          <i class="fas fa-trash-alt"></i>
        </button>
      </div>
    `).join('');
    
    document.getElementById('stat-today').innerText = this.tasks.filter(t => t.completed).length;
  }
};
</script>
